# Руководство по системе правил определения стадий

## Обзор

Система правил определения стадий позволяет гибко настраивать логику определения этапа воронки продаж на основе комбинации статусов заявки в системах Атлас и РР (Работа России).

## Основные компоненты

### 1. Модели статусов

#### AtlasStatus
- Хранит возможные статусы заявок в системе Атлас
- Поля:
  - `name` - название статуса
  - `order` - порядковый номер для сортировки
  - `is_active` - активность статуса

#### RRStatus
- Хранит возможные статусы заявок в системе РР
- Поля аналогичны AtlasStatus

### 2. Модель правил (StageRule)

Правило определяет, какая стадия воронки должна быть установлена при определенной комбинации статусов.

Поля:
- `pipeline` - воронка продаж
- `target_stage` - целевая стадия
- `atlas_status` - статус в Атлас (опционально)
- `rr_status` - статус в РР (опционально)
- `priority` - приоритет правила (меньше число = выше приоритет)
- `is_active` - активность правила
- `description` - описание правила

## Логика работы

1. При импорте заявки из Атлас извлекаются статусы из полей "Статус заявки в Атлас" и "Статус заявки в РР"
2. Система проверяет все активные правила для воронки в порядке приоритета
3. Первое совпавшее правило определяет стадию сделки
4. Если ни одно правило не подошло, используется старая логика из JSON файла

## Примеры правил

### Правило только по статусу РР
```
Статус РР: "Новая" → Стадия: "Первичный контакт"
Приоритет: 10
```

### Правило только по статусу Атлас
```
Статус Атлас: "Отклонена" → Стадия: "Отклонена"
Приоритет: 5 (высокий)
```

### Комбинированное правило
```
Статус Атлас: "Одобрена" И Статус РР: "Договор на подписании" → Стадия: "Договор"
Приоритет: 20
```

## Управление через админку

1. Перейдите в раздел "CRM Connector" в админке Django
2. Управляйте статусами через разделы "Статусы Атлас" и "Статусы РР"
3. Создавайте и редактируйте правила в разделе "Правила определения стадий"

## Команды управления

### Инициализация из JSON
```bash
python manage.py init_stage_rules --pipeline-name="Заявки (граждане)"
```
Эта команда создаст начальные статусы и правила на основе существующего файла `atlas_field_mapping.json`.

### Импорт заявок
```bash
python manage.py import_atlas_applications excel_file.xlsx
```
При импорте будет использоваться новая система правил для определения стадий.

## Приоритеты правил

Рекомендуемая схема приоритетов:
- 1-10: Критические правила (например, "Отклонена")
- 10-50: Комбинированные правила (оба статуса)
- 50-100: Правила по одному статусу
- 100+: Правила по умолчанию

## Отладка

Если стадия определяется неправильно:
1. Проверьте, что статусы существуют в базе данных
2. Убедитесь, что правило активно
3. Проверьте приоритеты правил
4. Посмотрите логи импорта для деталей 