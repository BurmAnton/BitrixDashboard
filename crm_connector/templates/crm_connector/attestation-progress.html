{% extends "base.html" %}
{% load dict_filters %}
{% block content %}
{% block extra_css %}
<style>
    form{ 
        text-align: left;
        padding: 12px;
        background-color: rgb(241, 241, 241);
        width: 35%;
        border-radius: 15px;
    }
    .tableTitle{
    display: flex;
    align-items: center;
    justify-content: space-between;
    }
    .container{
        width: 95%; 
        max-width: 95%;
        text-align: center;
    }
    .Export{
        background-color: #217346; /* зелёный цвет Excel */
        color: white;
        border: none;
        padding: 10px 30px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(33, 115, 70, 0.192);
        transition: background-color 0.3s ease;
        margin-bottom: 5px;
    }

    .Export:hover{
        background-color: #1b5f39;
    }

    .Export:active{
        background-color: #164c2f;
    }

    .potok{
        background:#ddd; 
        font-weight:bold;
    }

    span.copy {
    font-size: smaller;
    color: gray;
    cursor: pointer;
    }
    span.copy.clicked {
    color: #5cb85c;
    font-weight: bold;
    }
    span.copy:hover:not(.clicked) {
    color: #5bc0de;
    font-weight: bold;
    }

    .total-row{
        font-weight: bolder;
        background-color: #fff3cd !important;
        color: rgba(0, 0, 0, 0.774);
    }
    .total-row:hover{
        background-color: #ffeaa7 !important; 
    }

    table.custom-dashboard th:first-child{
        width: 18%;
    }

    table.custom-dashboard {
    margin-bottom: 25px;
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    word-wrap: break-word;
    font-family: Arial, sans-serif;
    font-size: large;
    }

    table.custom-dashboard th, table.custom-dashboard td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    vertical-align: middle;
    overflow-wrap: break-word;
    max-width: 150px;
    }

    table.custom-dashboard th {
    background-color: #f2f2f2;
    font-weight: bold;
    }

    table.custom-dashboard tr:nth-child(even) {
    background-color: #fafafa;
    }

    table.custom-dashboard tr:hover {
    background-color: #f1f1f1;
    }

    table.custom-dashboard td {
    white-space: normal;
    text-align: center;
    }
    .Success{
        font-weight: bolder;
        background-color: #5cb85c28 !important;
        color: black;
        margin: 2px 2px;
    }
    .Fail{
        font-weight: bolder;
        background-color: #d9544f2d !important;
        color: black;
        margin: 2px 2px;
    }
    .Empty{
        font-weight: bolder;
        background-color: #7272722c !important;
        color: black;
        margin: 2px 2px;
    }

</style>
{% endblock %}
<h1>Дашборд завершенных аттестаций </h1>
    <form method="post" enctype="multipart/form-data">
    <h2>Импорт заявок из Excel</h2>
    {% csrf_token %}
    {{ form.as_p }}
    <input type="submit" class="btn btn-primary"></button>
    </form>
{% for prog, potoki in result.items %}
    <div class="tableTitle">
        <h3 style="text-align: left;"> Программа {{ prog }}</h3>
        <button onclick="exportTableToXLSX(this.id)" id="{{ prog }}" class="Export">  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="m720-120 160-160-56-56-64 64v-167h-80v167l-64-64-56 56 160 160ZM560 0v-80h320V0H560ZM240-160q-33 0-56.5-23.5T160-240v-560q0-33 23.5-56.5T240-880h280l240 240v121h-80v-81H480v-200H240v560h240v80H240Zm0-80v-560 560Z"/></svg></button>
    </div>
    <table border="1" class="custom-dashboard" id="table.{{ prog }}">
    <thead>
        <tr>
        <th>Имя</th>
        {% for topic, value in topics.items %}
            {% if topic == prog %}
                {% for index, name in value.items %}
                
                    <th>
                        <label>
                            <input type="checkbox" class="filter-success" data-table-id="{{ prog }}" data-col-index="{{ forloop.counter0 }}">
                            {{ name }}
                        </label>
                    </th>
                {% endfor %}
            {% endif %}
        {% endfor %}
        <th>Итого</th>
        </tr>
    </thead>
    <tbody>
        {% for potok, listeners in potoki.items %}
        <tr class="potok" id="{{ potok }}">
            <td colspan="{{ topics|dict_get:prog|length|add:'2' }}" >
                <label>
                   <input type="checkbox" class="toggle-potok" data-potok-id="{{ potok }}"  checked>
                    {{ potok }}
                </label>
            </td>
        </tr>
            {% for name, tests in listeners.items %}
                {% if name == 'total' %}
                <tr class="total-row">
                <td >Общая сводка</td>
                {% for educ,topic  in topics.items %}
                    {% if educ == prog %}
                        {% for index, name in topic.items %}
                            <td >
                                {{tests|dict_get:name}}
                            </td>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                <td >
                    {{tests.undone}}
                    <br>
                    <span style="font-size:smaller;opacity: 50%;">
                        Всего: {{tests.total}}
                    </span>
                </td>
                </tr>
                {% else %}
                <tr id="{{ potok }}">
                <td>
                    <span>
                        {{ name }}
                    </span>
                    <br>
                    <span class="copy">{{ tests.email }}</span>
                    <br>
                        {% if tests.phone %}
                            <span class="copy">
                               {{ tests.phone }}
                            </span>
                        {% else %}
                            <span style="color: gray; font-size: smaller;">Нет телефона</span>
                        {% endif %}
                </td>
                {% for educ,topic  in topics.items %}
                    {% if educ == prog %}
                        {% for index, name in topic.items %}
                                {% with value=tests|dict_get:name %}
                                {% if value > 60 %}
                                    <td class="Success">{{ value }}</td>
                                {% elif value == 0 %}
                                    <td class="Empty">{{ value }}</td>
                                {% else %}
                                    <td class="Fail">{{ value }}</td>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
                {% with value=tests.total %}
                    {% if value == topics|dict_get:prog|length %}
                        <td class="Success">{{ value }}</td>
                    {% elif value == 0 %}
                        <td class="Empty">{{ value }}</td>
                    {% else %}
                        <td class="Fail">{{ value }}</td>
                    {% endif %}
                {% endwith %}
                </tr>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </tbody>
    </table>
{% endfor %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
  function exportTableToXLSX(ChoosenTable) {
    var table = document.getElementById('table.' + ChoosenTable);
    if (!table) {
        console.error("Таблица не найдена");
        return;
    }

    var workbook = XLSX.utils.book_new();

    // Заголовки (будут одинаковые для всех листов)
    var headerRow = ['ФИО', 'Email', 'Телефон'];
    var firstRow = table.querySelector('tr');
    var otherHeaders = [];

    if (firstRow) {
        var cells = Array.from(firstRow.cells);
        for (var i = 1; i < cells.length; i++) {
            otherHeaders.push(cells[i].innerText.trim());
        }
    }
    var headers = headerRow.concat(otherHeaders);

    // Получаем все строки с классом potok (потоки)
    var potokRows = table.querySelectorAll('tr.potok');

    potokRows.forEach(potokRow => {
        var potokName = potokRow.id;

        var data = [];
        data.push(headers);

        // Фильтруем строки с data-id равным потоку potokName
        var rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            if (row.querySelectorAll('th').length) return;
            if (row.style.display === 'none') return;
            if (row.classList.contains('potok')) return;
            if (row.id !== potokName) return;

            var rowData = [];
            var cells = Array.from(row.cells);

            if (row.classList.contains('total-row')) {
                return;
            } else {
                if (cells.length > 0) {
                    let firstCell = cells[0];
                    let spans = firstCell.querySelectorAll('span');
                    if (spans.length === 3) {
                        spans.forEach(span => rowData.push(span.innerText.trim()));
                    } else {
                        rowData.push(firstCell.innerText.trim(), '', '');
                    }
                }
                for (let i = 1; i < cells.length; i++) {
                    rowData.push(cells[i].innerText.trim());
                }
            }

            data.push(rowData);
        });
        if(data[1]){
            var worksheet = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, potokName);
        }
    });
    
    var wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });

    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    var blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = ChoosenTable + '.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


    document.addEventListener('DOMContentLoaded', () => {
        
        const emailSpans = document.querySelectorAll('.copy');
        emailSpans.forEach(span => {
            span.addEventListener('click', () => {
                
                navigator.clipboard.writeText(span.textContent)
                span.classList.add('clicked');
                setTimeout(() => {
                    span.classList.remove('clicked');
                }, 800);
            });
        });

        // Получаем все чекбоксы фильтров колонок
        const filters = document.querySelectorAll('input.filter-success');
        // Получаем все чекбоксы фильтра потоков
        const potokCheckboxes = document.querySelectorAll('input.toggle-potok');

        // Функция для получения текущих активных фильтров статусов по колонкам для каждой таблицы
        function getActiveColumnFiltersByTable() {
            const activeByTable = {};

            filters.forEach((filter) => {
                if (filter.checked) {
                    const tableId = 'table.'+filter.dataset.tableId; // id таблицы из data-атрибут
                    if (!activeByTable[tableId]) {
                        activeByTable[tableId] = new Set();
                    }
                    activeByTable[tableId].add(filter.dataset.colIndex);
                }
            });

            return activeByTable;
        }

        // Функция для проверки, скрыт ли поток по id (по чекбоксу)
        function isPotokVisible(potokId) {
            const potokCheckbox = Array.from(potokCheckboxes).find(cb => cb.dataset.potokId === potokId);
            return potokCheckbox ? potokCheckbox.checked : true;
        }

        // Основная функция фильтрации строк с учётом всех фильтров
        function applyFilters() {
            const activeFiltersByTable = getActiveColumnFiltersByTable();

            const tables = document.querySelectorAll('table.custom-dashboard');
            tables.forEach(table => {
                const tableId = table.id;
                // Получаем активные фильтры именно для этой таблицы
                const activeFilters = activeFiltersByTable[tableId] || new Set();

                const rows = table.tBodies[0].rows;

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];

                    // Пропускаем заголовочные строки потоков
                    if (row.classList.contains('potok')) {
                        continue;
                    }

                    const potokId = row.id;
                    if (potokId && !isPotokVisible(potokId)) {
                        row.style.setProperty('display', 'none', 'important');
                        continue;
                    }

                    // Если нет активных фильтров показываем все строки
                    if (activeFilters.size === 0) {
                        row.style.removeProperty('display');
                        continue;
                    }

                    let shouldShow = false;

                    activeFilters.forEach(colIndex => {
                        // Индексация столбцов +1, как было в исходном коде, предполагая первый столбец без фильтра
                        const cell = row.cells[parseInt(colIndex) + 1];
                        if (!cell) return;

                        const hasSuccess = cell.classList.contains('Success');
                        if (!hasSuccess) {
                            shouldShow = true;
                        }
                    });

                    if (shouldShow) {
                        row.style.removeProperty('display');
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // События изменения фильтров
        filters.forEach(filter => {
            filter.addEventListener('change', () => {
                applyFilters();
            });
        });

        potokCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                applyFilters();
            });
        });

        // Первоначальный запуск фильтрации
        applyFilters();

    })
    
</script>
{% endblock %}