{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <style>
        .col-sm-2{
            text-align: right;
        }
        .messages{
            display: none;
        }
        .container{
            width: 95%; 
            max-width: 95%;
        }
        label{
            font-size: smaller;
        }
        .code-block{
            background-color: #ebf2f3;
            border-radius: 12px;
            padding: 2%;
        }
    </style>
{% endblock %}

{% block content %}
<title>Авторизация токена</title>
<body>
    <div class="row" style="height: 100%;">
        <!-- Левая колонка: форма для тестов -->
        <div class="col-md-6">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header">
                        <h5>Получение списков организаций</h5>
                    </div>
                    <div class="card-body" style="height: 780px">
                        <form method="post">
                            {% csrf_token %}
                            <div class="mb-3 position-relative">
                                <label for="password" class="form-label">Токен</label>
                                <div class="input-group">
                                    <input type="password" readonly class="form-control form-control-sm" id="password" value="{{ token }}">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="togglePassword" style="width: 20%;">Показать</button>
                                </div>
                            </div>

                            <!-- Тип -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="typeInput" class="form-label me-2 mb-0">Тип</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="type" id="typeInput">
                            </div>

                            <!-- Дата -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="dateInput" class="form-label me-2 mb-0 flex-grow-1">Дата</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="date" id="dateInput">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="date">
                                    <label class="form-check-label" for="date">содержит</label>
                                </div>
                            </div>

                            <!-- Сфера деятельности -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="profActivityInput" class="form-label me-2 mb-0 flex-grow-1">Сфера деятельности</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="prof_activity" id="prof_activityInput">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="prof_activity" >
                                    <label class="form-check-label" for="prof_activity">содержит</label>
                                </div>
                            </div>

                            <!-- Проект -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="projectInput" class="form-label me-2 mb-0 flex-grow-1">Проект</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="project" id="projectInput">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="project">
                                    <label class="form-check-label" for="project">содержит</label>
                                </div>
                            </div>

                            <!-- Регион -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="regionInput" class="form-label me-2 mb-0 flex-grow-1">Регион</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="region" id="regionInput">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="region">
                                    <label class="form-check-label" for="region">содержит</label>
                                </div>
                            </div>

                            <!-- Федеральный округ -->
                            <div class="mb-3 d-flex align-items-center">
                                <div class="col-sm-2">
                                    <label for="fedDistrictInput" class="form-label me-2 mb-0 flex-grow-1">Федеральный округ</label>
                                </div>
                                <input type="text" class="form-control form-control-sm me-2" name="fed_ditrict" id="fedDistrictInput">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="fedDistrict">
                                    <label class="form-check-label" for="fedDistrict">содержит</label>
                                </div>
                            </div>

                            <!-- Федеральная компания -->
                            <div class="mb-3 d-flex align-items-center">
                                <label class="form-label me-2 mb-0">Федеральная компания</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="federal" id="federalTrue" value="true">
                                    <label class="form-check-label" for="federalTrue">Да</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="federal" id="federalFalse" value="false">
                                    <label class="form-check-label" for="federalFalse">Нет</label>
                                </div>
                                <div class="form-check form-check-inline ms-3">
                                    <input class="form-check-input" type="radio" name="federal" id="federalAll" value="" checked>
                                    <label class="form-check-label" for="federalAll">Все</label>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="apiLink" class="form-label">Ссылка API для fetch</label>
                                <input type="text" readonly class="form-control form-control-sm" id="apiLink" name="apiLink" value="{{ URL|safe }}">
                            </div>

                            <button type="submit" class="btn btn-primary btn-sm">Отправить</button>
                        </form>


                        <div class="card" style="margin-top: 12px; padding: 1%; height: 31%; overflow-y: auto; font-size: small;" >
                            <pre id="JsonResponse"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка: контент документации -->
        <div class="col-md-6">
            <div class="container-fluid">
                <div class="card">
                    <!-- Заголовок -->
                    <div class="card-header">
                        <h5>Документация REST API Organizations</h5>
                    </div>

                    <!-- Table of Contents -->
                    <div class="card-body" style="max-height: 780px; overflow-y: auto;">
                        <div class="toc">
                            <h3>Содержание:</h3>
                            <ul>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#intro">Введение</a></li>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#auth">1. Аутентификация</a></li>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#endpoint">2. Основной эндпоинт</a></li>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#filters">3. Фильтрация результатов</a></li>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#response">4. Формат ответа</a></li>
                                <li><a class="link-body-emphasis link-underline-opacity-0" href="#errors">5. Коды ответов и ошибки</a></li>
                            </ul>
                        </div>

                        <!-- Введение -->
                        <section id="intro">
                            <h2>Введение</h2>
                            <p>Добро пожаловать в документацию REST API для работы с организациями. Этот API предоставляет возможность получения информации об организациях, их типах, регионах, сферах деятельности и связанных проектах.</p>
                            <div class="alert alert-info">
                                <strong>Особенности API:</strong> Поддерживает расширенную фильтрацию по различным параметрам, включая вложенные связи (регионы, федеральные округа, проекты).
                            </div>
                        </section>

                        <!-- Аутентификация -->
                        <section id="auth">
                            <h2>1. Аутентификация</h2>
                            <p>Для доступа к API требуется токен.</p>

                            <ol>
                                <li>В админ‑панели Django перейдите в раздел "Токены".</li>
                                <li>Создайте новый токен для нужного пользователя.</li>
                                <li>Сохраните токен для будущего использования.</li>
                            </ol>
                        </section>

                        <!-- Основной эндпоинт -->
                        <section id="endpoint">
                            <h2>2. Основной эндпоинт</h2>

                            <h3>2.1 Получение данных об организациях</h3>
                            <table class="table table-bordered">
                                <tr>
                                    <td><strong>Эндпоинт:</strong></td>
                                    <td><code>/api/organizations/</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Метод HTTP:</strong></td>
                                    <td>GET</td>
                                </tr>
                                <tr>
                                    <td><strong>Аутентификация:</strong></td>
                                    <td>Требуется (токен в заголовке Authorization)</td>
                                </tr>
                                <tr>
                                    <td><strong>Пагинация:</strong></td>
                                    <td>Поддерживается (стандартная Django REST)</td>
                                </tr>
                            </table>

                            <h3>2.2 Формат запроса</h3>
                            <p><strong>Заголовки обязательные:</strong></p>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Заголовок</th>
                                        <th>Значение</th>
                                        <th>Описание</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>Authorization</code></td>
                                        <td><code>Token YOUR_TOKEN</code></td>
                                        <td>Токен аутентификации</td>
                                    </tr>
                                    <tr>
                                        <td><code>Accept</code></td>
                                        <td><code>application/json</code></td>
                                        <td>Формат ответа (рекомендуется)</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h3>2.3 Примеры использования</h3>

                            <div class="">Пример 1: JavaScript (Fetch API)</div>
                            <div class="code-block">
                                <pre><code>// Получение всех организаций
fetch('https://bitrix24.tuna-edu.ru/api/organizations/', {
    method: 'GET',
    headers: {
        'Authorization': 'Token 4a8389aa7f015d3a68e44e3f4bae94d63c7ac097',
        'Accept': 'application/json'
    }
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Ошибка:', error));</code></pre>
                            </div>

                            <div class="">Пример 2: cURL</div>
                            <div class="code-block">
                                <pre><code>curl -X GET 'https://bitrix24.tuna-edu.ru/api/organizations/' \
            -H 'Authorization: Token 4a8389aa7f015d3a68e44e3f4bae94d63c7ac097' \
            -H 'Accept: application/json'</code></pre>
                            </div>

                            <div class="">Пример 3: Python (Requests)</div>
                            <div class="code-block">
                                <pre><code>import requests
headers = {
    'Authorization': 'Token 4a8389aa7f015d3a68e44e3f4bae94d63c7ac097',
    'Accept': 'application/json'
}
response = requests.get('https://bitrix24.tuna-edu.ru/api/organizations/', headers=headers)
data = response.json()
print(data)</code></pre>
                            </div>
                        </section>

                        <!-- Фильтрация -->
                        <section id="filters">
                            <h2>3. Фильтрация результатов</h2>
                            <p>API поддерживает расширенную фильтрацию по различным параметрам организаций.</p>

                            <h3>3.1 Доступные фильтры</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Фильтр</th>
                                        <th>Параметр</th>
                                        <th>Описание</th>
                                        <th>Тип поиска</th>
                                        <th>Примечание</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Тип организации</td>
                                        <td><code>type</code></td>
                                        <td>Тип организации (например, "РОИВ")</td>
                                        <td>Точное совпадение</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Дата создания (содержит)</td>
                                        <td><code>date</code></td>
                                        <td>Поиск по части даты создания</td>
                                        <td>Частичное совпадение</td>
                                        <td>Формат: YYYY-MM-DD</td>
                                    </tr>
                                    <tr>
                                        <td>Сфера деятельности</td>
                                        <td><code>prof_activity</code></td>
                                        <td>Сфера деятельности</td>
                                        <td>Точное совпадение</td>
                                        <td>Только для РОИВ</td>
                                    </tr>
                                    <tr>
                                        <td>Сфера деятельности (содержит)</td>
                                        <td><code>prof_activity__contains</code></td>
                                        <td>Поиск по части названия сферы деятельности</td>
                                        <td>Частичное совпадение</td>
                                        <td>Только для РОИВ</td>
                                    </tr>
                                    <tr>
                                        <td>Проект</td>
                                        <td><code>project</code></td>
                                        <td>Поиск организаций по проектам</td>
                                        <td>Частичное совпадение</td>
                                        <td>По названию проекта</td>
                                    </tr>
                                    <tr>
                                        <td>Регион</td>
                                        <td><code>region</code></td>
                                        <td>Название региона</td>
                                        <td>Точное совпадение</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Регион (содержит)</td>
                                        <td><code>region__contains</code></td>
                                        <td>Поиск по части названия региона</td>
                                        <td>Частичное совпадение</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Федеральный округ</td>
                                        <td><code>fed_district</code></td>
                                        <td>Название федерального округа</td>
                                        <td>Точное совпадение</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Федеральный округ (содержит)</td>
                                        <td><code>fed_district__contains</code></td>
                                        <td>Поиск по части названия фед. округа</td>
                                        <td>Частичное совпадение</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>Федеральная компания</td>
                                        <td><code>federal</code></td>
                                        <td>Фильтр по федеральным компаниям</td>
                                        <td>Булевый</td>
                                        <td>true/false</td>
                                    </tr>
                                    <tr>
                                        <td>Активность</td>
                                        <td><code>is_active</code></td>
                                        <td>Фильтр по активности организации</td>
                                        <td>Булевый</td>
                                        <td>true/false</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h3>3.2 Синтаксис фильтрации</h3>
                            <p>Фильтры передаются как query-параметры в URL:</p>
                            <div class="code-block">
                                <code>/api/organizations/?filter1=value1&filter2=value2</code>
                            </div>

                            <h3>3.3 Примеры фильтрации</h3>

                            <div class="">Пример 1: Поиск по типу организации</div>
                            <div class="code-block">
                                <code>https://bitrix24.tuna-edu.ru/api/organizations/?type=РОИВ</code>
                            </div>

                            <div class="">Пример 2: Поиск по региону и федеральному статусу</div>
                            <div class="code-block">
                                <code>https://bitrix24.tuna-edu.ru/api/organizations/?region__contains=Москва&federal=true</code>
                            </div>

                            <div class="">Пример 3: Поиск организаций с проектом</div>
                            <div class="code-block">
                                <code>https://bitrix24.tuna-edu.ru/api/organizations/?project=Цифровая%20трансформация</code>
                            </div>

                            <div class="">Пример 4: Комбинированный поиск для РОИВ</div>
                            <div class="code-block">
                                <code>https://bitrix24.tuna-edu.ru/api/organizations/?type=РОИВ&prof_activity__contains=образование&fed_district=Центральный</code>
                            </div>

                            <div class="alert alert-warning mt-3">
                                <strong>Обратите внимание:</strong> Фильтры <code>prof_activity</code> и <code>prof_activity__contains</code> работают только при установленном параметре <code>type=РОИВ</code>.
                            </div>
                        </section>

                        <!-- Формат ответа -->
                        <section id="response">
                            <h2>4. Формат ответа</h2>

                            <h3>4.1 Успешный ответ (HTTP 200 OK)</h3>
                            <p>API возвращает список организаций с детальной информацией.</p>

                            <div class="code-block" style="height: 400px; overflow-y: auto; font-size: small;">
                                <pre><code>[
    {
        "name": "ООО \"Рога и копыта\"",
        "full_name": "Общество с ограниченной ответственностью \"Рога и копыта\"",
        "type": "Коммерческая",
        "region": "Московская область",
        "federal_company": false,
        "fed_district": "Центральный",
        "prof_activity": "IT-услуги",
        "projects": [
            {"name": "Цифровизация"},
            {"name": "Автоматизация"}
        ],
        "is_active": true,
        "created_at": "2023-05-15T10:30:00Z",
        "updated_at": "2024-01-20T14:45:00Z"
    },
    {
        "name": "Минобрнауки",
        "full_name": "Министерство образования и науки",
        "type": "РОИВ",
        "region": "Москва",
        "federal_company": true,
        "fed_district": "Центральный",
        "prof_activity": "Образование",
        "projects": [
            {"name": "Национальный проект \"Образование\""}
        ],
        "is_active": true,
        "created_at": "2022-01-10T09:00:00Z",
        "updated_at": "2023-11-05T16:20:00Z"
    }
]</code></pre>
                            </div>

                            <h3>4.2 Структура данных в ответе</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Поле</th>
                                        <th>Тип</th>
                                        <th>Описание</th>
                                    </tr>
                                </thead>
                                    <tr>
                                        <td><code>name</code></td>
                                        <td>String</td>
                                        <td>Краткое название организации</td>
                                    </tr>
                                    <tr>
                                        <td><code>full_name</code></td>
                                        <td>String</td>
                                        <td>Полное официальное название</td>
                                    </tr>
                                    <tr>
                                        <td><code>type</code></td>
                                        <td>String</td>
                                        <td>Тип организации</td>
                                    </tr>
                                    <tr>
                                        <td><code>region</code></td>
                                        <td>String</td>
                                        <td>Регион расположения</td>
                                    </tr>
                                    <tr>
                                        <td><code>federal_company</code></td>
                                        <td>Boolean</td>
                                        <td>Является ли федеральной компанией</td>
                                    </tr>
                                    <tr>
                                        <td><code>fed_district</code></td>
                                        <td>String</td>
                                        <td>Федеральный округ</td>
                                    </tr>
                                    <tr>
                                        <td><code>prof_activity</code></td>
                                        <td>String</td>
                                        <td>Сфера деятельности (для РОИВ)</td>
                                    </tr>
                                    <tr>
                                        <td><code>projects</code></td>
                                        <td>Array</td>
                                        <td>Список проектов организации</td>
                                    </tr>
                                    <tr>
                                        <td><code>is_active</code></td>
                                        <td>Boolean</td>
                                        <td>Активна ли организация</td>
                                    </tr>
                                    <tr>
                                        <td><code>created_at</code></td>
                                        <td>String (ISO 8601)</td>
                                        <td>Дата создания записи</td>
                                    </tr>
                                    <tr>
                                        <td><code>updated_at</code></td>
                                        <td>String (ISO 8601)</td>
                                        <td>Дата последнего обновления</td>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <!-- Коды ответов -->
                        <section id="errors">
                            <h2>5. Коды ответов и ошибки</h2>

                            <h3>5.1 Успешные коды ответов</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Код</th>
                                        <th>Описание</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>200</code></td>
                                        <td>OK — Запрос выполнен успешно</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h3>5.2 Коды ошибок</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Код</th>
                                        <th>Описание</th>
                                        <th>Решение</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>400</code></td>
                                        <td>Bad Request — Неверный формат запроса</td>
                                        <td>Проверьте синтаксис URL и параметры фильтрации</td>
                                    </tr>
                                    <tr>
                                        <td><code>401</code></td>
                                        <td>Unauthorized — Требуется аутентификация</td>
                                        <td>Убедитесь, что передали корректный токен</td>
                                    </tr>
                                    <tr>
                                        <td><code>403</code></td>
                                        <td>Forbidden — Доступ запрещен</td>
                                        <td>Ваш токен не имеет прав на доступ к API</td>
                                    </tr>
                                    <tr>
                                        <td><code>404</code></td>
                                        <td>Not Found — Ресурс не найден</td>
                                        <td>Проверьте правильность URL эндпоинта</td>
                                    </tr>
                                    <tr>
                                        <td><code>500</code></td>
                                        <td>Internal Server Error — Ошибка сервера</td>
                                        <td>Попробуйте позже или обратитесь к администратору</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h3>5.3 Примеры ошибок</h3>

                            <div class="">Ошибка 401: Отсутствует токен</div>
                            <div class="code-block">
                                <pre><code>{
    "detail": "Authentication credentials were not provided."
}</code></pre>
                            </div>
                            <p style="margin-top: 10px;"><strong>Решение:</strong> Добавьте заголовок Authorization с вашим токеном.</p>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    document.getElementById('togglePassword').addEventListener('click', function () {
        console.log("click")
        const passwordInput = document.getElementById('password');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.textContent = type === 'password' ? 'Показать' : 'Скрыть';
    });
    pre = document.getElementById('JsonResponse')
    const jsonResponse = {{ JsonReponse|safe  }};
    const formattedJson = JSON.stringify(jsonResponse, null, 2);
    pre.textContent = formattedJson;

    
    function updateTextInputNames() {
    // Получаем все чекбоксы на странице
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');

    checkboxes.forEach(checkbox => {
        // Получаем id чекбокса
        const checkboxId = checkbox.id;

        // Находим текстовый input, id которого содержит id чекбокса
        // Используем атрибут селектор *= для проверки включения подстроки в id
        const textInput = document.querySelector(`input[type="text"][id*="${checkboxId}"]`);

        if (textInput) {
            // Запоминаем базовый нейм (без приставки)
            const baseName = textInput.getAttribute('data-base-name') || textInput.name.replace(/__contains$/, '');

            // Сохраняем базовый нейм в data-атрибут для повторного использования
            textInput.setAttribute('data-base-name', baseName);

            if (checkbox.checked) {
                // Добавляем приставку __contains, если ее еще нет
                if (!textInput.name.endsWith('__contains')) {
                    textInput.name = baseName + '__contains';
                }
            } else {
                // Убираем приставку, если чекбокс не отмечен
                textInput.name = baseName;
            }
        }
    });
}

    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            updateTextInputNames();
        });
    });

    // Вызовем функцию один раз при загрузке страницы, чтобы синхронизировать имена
    updateTextInputNames();

</script>
{% endblock %}
